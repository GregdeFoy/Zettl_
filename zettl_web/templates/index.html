<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zettl Web</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --header-bg: #333;
            --terminal-text: #f0f0f0;
            --primary-color: #90ee90;
            --button-bg: #4a4a4a;
            --button-hover: #666;
            --input-bg: #333;
            --input-border: #555;
            --green: #90ee90;
            --blue: #add8e6;
            --yellow: #ffff00;
            --red: #ff6347;
            --cyan: #00ffff;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Courier New', monospace;
            background-color: var(--bg-color);
            color: var(--terminal-text);
            display: flex;
            flex-direction: column;
        }

        #header {
            background-color: var(--header-bg);
            color: var(--primary-color);
            padding: 10px 15px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
            border-bottom: 1px solid #444;
        }

        #app-container {
            display: flex;
            flex-direction: column;
            height: calc(100% - 43px); /* Subtract header height */
            position: relative;
            overflow: hidden;
        }

        #terminal-output {
            flex: 1 1 auto;
            overflow-y: auto;
            padding: 15px;
            font-size: 16px;
            line-height: 1.4;
            scrollbar-width: thin;
            scrollbar-color: var(--button-bg) var(--bg-color);
            -webkit-overflow-scrolling: touch;
        }

        #terminal-output::-webkit-scrollbar {
            width: 8px;
        }

        #terminal-output::-webkit-scrollbar-track {
            background: var(--bg-color);
        }

        #terminal-output::-webkit-scrollbar-thumb {
            background-color: var(--button-bg);
            border-radius: 4px;
        }

        #terminal-output .output-line {
            margin-bottom: 8px;
            white-space: pre-wrap;
            word-break: break-word;
        }

        /* ASCII art logo handling */
        #terminal-output .logo-container {
            overflow-x: auto;
            white-space: nowrap;
            margin-bottom: 15px;
            padding-bottom: 5px;
            font-size: 0.9em;
        }

        /* Colors for terminal output */
        #terminal-output .green { color: var(--green); }
        #terminal-output .blue { color: var(--blue); }
        #terminal-output .yellow { color: var(--yellow); }
        #terminal-output .red { color: var(--red); }
        #terminal-output .cyan { color: var(--cyan); }
        #terminal-output .bold { font-weight: bold; }

        #input-area {
            flex: 0 0 auto;
            background-color: var(--header-bg);
            border-top: 2px solid #444;
            padding: 10px;
            position: relative;
            z-index: 100;
        }

        #shortcut-buttons {
            display: flex;
            overflow-x: auto;
            margin-bottom: 8px;
            padding-bottom: 5px;
            scrollbar-width: none;
            -webkit-overflow-scrolling: touch;
        }

        #shortcut-buttons::-webkit-scrollbar {
            display: none;
        }

        #shortcut-buttons button {
            background-color: var(--button-bg);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            margin-right: 8px;
            font-family: 'Courier New', monospace;
            white-space: nowrap;
            flex-shrink: 0;
        }

        #shortcut-buttons button:hover {
            background-color: var(--button-hover);
        }

        #input-wrapper {
            display: flex;
            width: 100%;
            position: relative;
        }

        #prompt-label {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary-color);
            pointer-events: none;
            user-select: none;
            z-index: 1;
        }

        #command-input {
            flex-grow: 1;
            background-color: var(--input-bg);
            color: var(--terminal-text);
            border: 1px solid var(--input-border);
            border-radius: 4px;
            padding: 8px 12px 8px 65px; /* Added left padding for prompt */
            font-family: 'Courier New', monospace;
            font-size: 16px;
            outline: none;
            position: relative;
        }

        #submit-button {
            background-color: var(--primary-color);
            color: #000;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            margin-left: 8px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            cursor: pointer;
        }

        .loading-indicator {
            display: inline-block;
            margin-left: 10px;
            animation: pulse 1s infinite;
        }

        /* Extra padding for safari to account for toolbar */
        @supports (-webkit-touch-callout: none) {
            #terminal-output {
                padding-bottom: 70px;
            }
        }

        @keyframes pulse {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }

        /* Make sure we account for iOS safe areas */
        @supports (padding-bottom: env(safe-area-inset-bottom)) {
            #input-area {
                padding-bottom: calc(10px + env(safe-area-inset-bottom));
            }
        }

        /* Adjust for different screen sizes */
        @media (min-width: 768px) {
            #terminal-output {
                font-size: 14px;
            }
            
            #command-input {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div id="header">
        <span>Zettl Web Terminal</span>
        <span id="username">Logged in as: {{ username }}</span>
    </div>

    <div id="app-container">
        <div id="terminal-output">
            <!-- Terminal output will be inserted here -->
        </div>
        
        <div id="input-area">
            <div id="shortcut-buttons">
                <button data-cmd="list --full">list --full</button>
                <button data-cmd="new">new</button>
                <button data-cmd="show">show</button>
                <button data-cmd="search">search</button>
                <button data-cmd="todos --all">todos --all</button>
                <button data-cmd="tags">tags</button>
                <button data-cmd="link">link</button>
                <button data-cmd="related">related</button>
                <button data-cmd="help">help</button>
            </div>
            <div id="input-wrapper">
                <span id="prompt-label">zettl&gt;</span>
                <input type="text" id="command-input" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
                <button id="submit-button">↵</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Get DOM elements
            const terminalOutput = document.getElementById('terminal-output');
            const commandInput = document.getElementById('command-input');
            const submitButton = document.getElementById('submit-button');
            const shortcutButtons = document.getElementById('shortcut-buttons');
            
            // Command history
            let commandHistory = loadHistory();
            let historyIndex = commandHistory.length;
            
            // Create a container for the logo to handle overflow better
            const logoContainer = document.createElement('div');
            logoContainer.className = 'logo-container';
            logoContainer.innerHTML = `
<pre>
████████ ████████ ████████ ████████ ██
      ██ ██          ██       ██    ██
   ██    ████████    ██       ██    ██
██       ██          ██       ██    ██
████████ ████████    ██       ██    ████████</pre>`;
            
            // Add the logo container to the terminal output
            terminalOutput.appendChild(logoContainer);
            
            // Add the welcome text
            appendOutput("Welcome to Zettl Web Terminal. Type 'help' for commands.");
            appendOutput("Type 'list' to see your recent notes.");
            
            // Focus the input field
            setTimeout(() => {
                commandInput.focus();
            }, 300);
            
            // Handle keyboard events for command input
            commandInput.addEventListener('keydown', function(e) {
                // Enter key submits command
                if (e.key === 'Enter') {
                    e.preventDefault();
                    executeCommand(commandInput.value);
                }
                // Up arrow for previous command
                else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    if (historyIndex > 0) {
                        historyIndex--;
                        commandInput.value = commandHistory[historyIndex];
                        // Move cursor to end of input
                        setTimeout(() => {
                            commandInput.selectionStart = commandInput.selectionEnd = commandInput.value.length;
                        }, 0);
                    }
                }
                // Down arrow for next command
                else if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    if (historyIndex < commandHistory.length) {
                        historyIndex++;
                        commandInput.value = historyIndex === commandHistory.length ? '' : commandHistory[historyIndex];
                        // Move cursor to end of input
                        setTimeout(() => {
                            commandInput.selectionStart = commandInput.selectionEnd = commandInput.value.length;
                        }, 0);
                    }
                }
                // Tab for shortcuts (simple implementation)
                else if (e.key === 'Tab') {
                    e.preventDefault();
                    const currentCmd = commandInput.value.trim().split(' ')[0];
                    const shortcuts = ['list', 'new', 'show', 'search', 'tags', 'link', 'related', 'help'];
                    
                    if (currentCmd) {
                        const matches = shortcuts.filter(cmd => cmd.startsWith(currentCmd));
                        if (matches.length === 1) {
                            commandInput.value = matches[0] + ' ';
                        }
                    }
                }
            });
            
            // Handle submit button click
            submitButton.addEventListener('click', function() {
                executeCommand(commandInput.value);
            });
            
            // Handle shortcut buttons
            shortcutButtons.addEventListener('click', function(e) {
                if (e.target.tagName === 'BUTTON') {
                    const cmd = e.target.dataset.cmd;
                    commandInput.value = cmd + ' ';
                    commandInput.focus();
                }
            });

            // Handle iOS focus issues
            commandInput.addEventListener('focus', function() {
                // Ensure keyboard doesn't push content around
                setTimeout(() => {
                    window.scrollTo(0, 0);
                    document.body.scrollTop = 0;
                }, 50);
            });

            // Execute the command
            function executeCommand(command) {
                const cmd = command.trim();
                if (!cmd) return;
                
                // Echo command with prompt
                appendOutput(`zettl> ${cmd}`);
                
                // Add to history if not duplicate of most recent
                if (commandHistory.length === 0 || commandHistory[commandHistory.length - 1] !== cmd) {
                    commandHistory.push(cmd);
                    saveHistory(commandHistory);
                }
                
                // Reset history index
                historyIndex = commandHistory.length;
                
                // Clear input
                commandInput.value = '';
                
                // Show loading indicator
                const loadingId = `loading-${Date.now()}`;
                appendOutput(`<span id="${loadingId}">Processing command... ⏳</span>`);
                
                // Send command to server
                fetch('/api/command', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ command: cmd })
                })
                .then(response => response.json())
                .then(data => {
                    // Remove loading indicator
                    const loadingElement = document.getElementById(loadingId);
                    if (loadingElement) {
                        loadingElement.remove();
                    }
                    
                    // Append result
                    appendOutput(data.result, true);
                    
                    // Scroll to bottom
                    terminalOutput.scrollTop = terminalOutput.scrollHeight;
                })
                .catch(error => {
                    // Remove loading indicator
                    const loadingElement = document.getElementById(loadingId);
                    if (loadingElement) {
                        loadingElement.remove();
                    }
                    
                    // Show error
                    appendOutput(`<span class="red">Error: ${error.message || 'Connection failed'}</span>`);
                    
                    // Scroll to bottom
                    terminalOutput.scrollTop = terminalOutput.scrollHeight;
                });
                
                // Focus input again
                commandInput.focus();
            }
            
            // Append output to terminal
            function appendOutput(content, isHTML = false) {
                const outputLine = document.createElement('div');
                outputLine.className = 'output-line';
                
                if (isHTML) {
                    outputLine.innerHTML = content;
                } else {
                    outputLine.textContent = content;
                }
                
                terminalOutput.appendChild(outputLine);
                terminalOutput.scrollTop = terminalOutput.scrollHeight;
            }
            
            // Save command history to localStorage
            function saveHistory(history) {
                try {
                    // Keep only the last 100 commands
                    const limitedHistory = history.slice(-100);
                    localStorage.setItem('zettl_history', JSON.stringify(limitedHistory));
                } catch (e) {
                    console.error('Error saving history', e);
                }
            }
            
            // Load command history from localStorage
            function loadHistory() {
                try {
                    const history = localStorage.getItem('zettl_history');
                    return history ? JSON.parse(history) : [];
                } catch (e) {
                    console.error('Error loading history', e);
                    return [];
                }
            }

            // Adjust terminal height on orientation change
            window.addEventListener('resize', function() {
                // Small delay to allow browser UI to settle
                setTimeout(() => {
                    // Ensure we see the latest content
                    terminalOutput.scrollTop = terminalOutput.scrollHeight;
                }, 100);
            });

            // Handle iOS viewport issues
            if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                // Visual viewport awareness
                if (window.visualViewport) {
                    window.visualViewport.addEventListener('resize', () => {
                        // Prevent scrolling when keyboard appears
                        document.body.style.height = window.visualViewport.height + 'px';
                        window.scrollTo(0, 0);
                    });
                }
            }
        });
    </script>
</body>
</html>