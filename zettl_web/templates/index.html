<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zettl Web</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/jquery.terminal/2.37.2/css/jquery.terminal.min.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            background-color: #1a1a1a;
            font-family: 'Courier New', monospace;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }
        
        #header {
            background-color: #333;
            color: #90ee90;
            padding: 10px 15px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        #terminal-container {
            flex: 1;
            width: 100%;
            overflow: auto;
            -webkit-overflow-scrolling: touch;
            position: relative;
        }
        
        .terminal {
            --size: 1.2;
            height: 100%;
        }
        
        /* Terminal colors */
        .terminal .green { color: #90ee90; }
        .terminal .blue { color: #add8e6; }
        .terminal .yellow { color: #ffff00; }
        .terminal .red { color: #ff6347; }
        .terminal .cyan { color: #00ffff; }
        .terminal .bold { font-weight: bold; }
        
        .terminal .output-line {
            line-height: 1.4;
        }
        
        .terminal .note-separator {
            margin: 10px 0;
            border-bottom: 1px dashed #444;
        }
        
        .terminal .note-block {
            margin-bottom: 15px;
            padding: 5px;
            border-left: 3px solid #444;
        }
        
        /* Mobile styles */
        @media (max-width: 768px) {
            .terminal {
                --size: 1.4;
            }
            
            /* Mobile toolbar */
            #mobile-toolbar {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background-color: rgba(51, 51, 51, 0.95);
                z-index: 1000;
                box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.5);
            }
            
            .toolbar-row {
                display: flex;
                justify-content: space-around;
                flex-wrap: wrap;
                padding: 5px 0;
            }
            
            #mobile-toolbar button {
                background-color: #4a4a4a;
                color: white;
                border: none;
                padding: 8px 12px;
                margin: 3px;
                border-radius: 4px;
                font-family: 'Courier New', monospace;
                min-width: 40px;
            }
            
            /* Custom keyboard */
            #special-keys {
                background-color: rgba(40, 40, 40, 0.95);
                border-top: 1px solid #555;
                padding: 5px 0;
            }
            
            /* Make room for mobile toolbar */
            #terminal-container {
                padding-bottom: 60px;
            }
            
            /* Keyboard toggle button */
            #keyboard-toggle {
                position: fixed;
                bottom: 70px;
                right: 10px;
                z-index: 1001;
                width: 40px;
                height: 40px;
                border-radius: 50%;
                background-color: rgba(100, 100, 100, 0.7);
                color: white;
                border: none;
                font-size: 16px;
            }
        }
        
        @media (min-width: 769px) {
            #mobile-toolbar, #keyboard-toggle {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div id="header">
        <span>Zettl Web Terminal</span>
        <span>Logged in as: {{ username }}</span>
    </div>
    
    <div id="terminal-container"></div>
    
    <!-- Mobile keyboard toggle -->
    <button id="keyboard-toggle">⌨️</button>
    
    <!-- Mobile toolbar -->
    <div id="mobile-toolbar">
        <div class="toolbar-row">
            <button onclick="insertCommand('list')">list</button>
            <button onclick="insertCommand('new')">new</button>
            <button onclick="insertCommand('search')">search</button>
            <button onclick="insertCommand('help')">help</button>
        </div>
        <div id="special-keys" class="toolbar-row">
            <button onclick="insertSpecialKey('Tab')">Tab</button>
            <button onclick="insertSpecialKey('ArrowLeft')">←</button>
            <button onclick="insertSpecialKey('ArrowUp')">↑</button>
            <button onclick="insertSpecialKey('ArrowDown')">↓</button>
            <button onclick="insertSpecialKey('ArrowRight')">→</button>
            <button onclick="insertSpecialKey('Escape')">Esc</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.terminal/2.37.2/js/jquery.terminal.min.js"></script>
    <script>
        $(function() {
            // Initially hide special keys
            $('#special-keys').hide();
            
            // Toggle special keys
            $('#keyboard-toggle').on('click', function() {
                $('#special-keys').toggle();
            });
            
            // Mobile detection
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            
            if (isIOS) {
                $('body').addClass('ios-device');
            }
            
            // Terminal initialization
            let term = $('#terminal-container').terminal(function(command) {
                if (command.trim() === '') {
                    return;
                }
                
                // Show loading indicator
                term.pause();
                const loadingIndicator = term.echo('Processing command... ⏳', {
                    finalize: function(div) {
                        $(div).addClass('loading-indicator');
                    }
                });
                
                // Send command to server
                $.ajax({
                    url: '/api/command',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ command: command }),
                    success: function(response) {
                        term.resume();
                        
                        // Remove loading indicator
                        $('.loading-indicator').remove();
                        
                        // Output response
                        term.echo(response.result, {
                            raw: true,
                            finalize: function(div) {
                                div.find('.green').css('color', '#90ee90');
                                div.find('.blue').css('color', '#add8e6');
                                div.find('.yellow').css('color', '#ffff00');
                                div.find('.red').css('color', '#ff6347');
                                div.find('.cyan').css('color', '#00ffff');
                                div.find('.bold').css('font-weight', 'bold');
                            }
                        });
                        
                        // Ensure visibility after response on mobile
                        if (isMobile) {
                            setTimeout(function() {
                                term.scroll_to_bottom();
                            }, 10);
                        }
                    },
                    error: function(xhr) {
                        term.resume();
                        $('.loading-indicator').remove();
                        term.error('Server error: ' + (xhr.responseText || 'Connection failed'));
                    }
                });
            }, {
                greetings: `
█████ █████ ████████ ████████ ██
   █  ██       ██       ██    ██
 ██   █████    ██       ██    ██   
█     ██       ██       ██    ██
█████ █████    ██       ██    ███████

Welcome to Zettl Web Terminal. Type 'help' for commands.
Type 'list' to see your recent notes.
`,
                prompt: 'zettl> ',
                name: 'zettl-web',
                historySize: 100,
                clear: false,
                exit: false,
                wrap: true,
                historyPersistedState: true,
                scrollOnEcho: true,
                height: '100%'
            });
            
            // Handle command insertion from mobile buttons
            window.insertCommand = function(cmd) {
                term.set_command(cmd + ' ');
                term.focus();
                
                if (isIOS) {
                    // On iOS, force focus input to show keyboard
                    setTimeout(function() {
                        term.focus(true);
                    }, 100);
                }
            };
            
            // Handle special key insertion
            window.insertSpecialKey = function(key) {
                const e = $.Event('keydown');
                
                switch(key) {
                    case 'Tab':      e.which = 9;   break;
                    case 'ArrowUp':  e.which = 38;  break;
                    case 'ArrowDown':e.which = 40;  break;
                    case 'ArrowLeft':e.which = 37;  break;
                    case 'ArrowRight':e.which = 39; break;
                    case 'Escape':   e.which = 27;  break;
                    default: return;
                }
                
                term.trigger(e);
                term.focus();
            };
            
            // Save history to local storage
            if (localStorage.getItem('zettl_history')) {
                try {
                    const history = JSON.parse(localStorage.getItem('zettl_history'));
                    for (const cmd of history) {
                        term.history().append(cmd);
                    }
                } catch (e) {
                    console.error('Error loading history:', e);
                }
            }
            
            term.on('history', function(command) {
                const history = term.history().data();
                localStorage.setItem('zettl_history', JSON.stringify(history));
            });
            
            // Mobile-specific optimizations
            if (isMobile) {
                // Ensure terminal gets focus on mobile
                setTimeout(function() {
                    term.focus();
                }, 500);
                
                // iOS-specific fixes
                if (isIOS) {
                    // Store original height
                    const originalHeight = window.innerHeight;
                    
                    // Handle keyboard visibility
                    function adjustKeyboard() {
                        // Check if keyboard is visible by comparing heights
                        const currentHeight = window.innerHeight;
                        const keyboardHeight = originalHeight - currentHeight;
                        
                        if (keyboardHeight > 100) { // Keyboard is visible
                            // Move toolbar above keyboard
                            $('#mobile-toolbar').css({
                                'transform': 'translateY(-' + keyboardHeight + 'px)',
                                'transition': 'transform 0.1s'
                            });
                            
                            // Adjust terminal container
                            $('#terminal-container').css('padding-bottom', (keyboardHeight + 10) + 'px');
                            
                            // Scroll terminal to ensure input is visible
                            setTimeout(function() {
                                // Find input line
                                const cmd = $('.cmd-line').last();
                                if (cmd.length) {
                                    // Scroll to make input visible
                                    cmd[0].scrollIntoView(false);
                                }
                            }, 200);
                            
                            // Keep focus on terminal
                            term.focus(true);
                        } else { // Keyboard is hidden
                            // Reset toolbar position
                            $('#mobile-toolbar').css({
                                'transform': 'translateY(0)',
                                'transition': 'transform 0.1s'
                            });
                            
                            // Reset terminal container
                            $('#terminal-container').css('padding-bottom', '60px');
                        }
                    }
                    
                    // Handle keyboard on input
                    term.on('keypress', function() {
                        // Force scroll on keypress
                        setTimeout(function() {
                            term.scroll_to_bottom();
                        }, 0);
                    });
                    
                    // Use visualViewport API if available (iOS 13+)
                    if (window.visualViewport) {
                        window.visualViewport.addEventListener('resize', function() {
                            adjustKeyboard();
                        });
                    } else {
                        // Fallback for older iOS
                        $(window).on('resize', function() {
                            adjustKeyboard();
                        });
                    }
                    
                    // Fix iOS touch scrolling
                    document.addEventListener('touchmove', function(e) {
                        // Use passive listener to improve scroll performance
                    }, { passive: true });
                }
            }
        });
    </script>
</body>
</html>