<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zettl Web</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/jquery.terminal/2.37.2/css/jquery.terminal.min.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            background-color: #1a1a1a;
            font-family: 'Courier New', monospace;
            display: flex;
            flex-direction: column;
        }
        
        #header {
            background-color: #333;
            color: #90ee90;
            padding: 10px 15px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        #terminal-container {
            flex: 1;
            width: 100%;
        }
        
        /* Override terminal styles for better mobile experience */
        .terminal {
            --size: 1.2;
        }
        
        /* Custom terminal colors to match Zettl CLI */
        .terminal .green {
            color: #90ee90;
        }
        
        .terminal .blue {
            color: #add8e6;
        }
        
        .terminal .yellow {
            color: #ffff00;
        }
        
        .terminal .red {
            color: #ff6347;
        }
        
        .terminal .cyan {
            color: #00ffff;
        }
        
        .terminal .bold {
            font-weight: bold;
        }

        .terminal .output-line {
            line-height: 1.4;  /* Increase line height for better readability */
        }

        .terminal .note-separator {
            margin: 10px 0;
            border-bottom: 1px dashed #444;
        }

        /* Style for note blocks */
        .terminal .note-block {
            margin-bottom: 15px;
            padding: 5px;
            border-left: 3px solid #444;
        }

        /* Style terminal <br> elements for better spacing */
        .terminal br {
            line-height: 1.5;
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            .terminal {
                --size: 1.4; /* Larger text on mobile */
            }
            
            #mobile-buttons {
                display: flex;
                justify-content: space-around;
                background-color: #333;
                padding: 10px 0;
            }
            
            #mobile-buttons button {
                background-color: #4a4a4a;
                color: white;
                border: none;
                padding: 8px 12px;
                border-radius: 4px;
                font-family: 'Courier New', monospace;
            }
        }
        
        @media (min-width: 769px) {
            #mobile-buttons {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div id="header">
        <span>Zettl Web Terminal</span>
        <span>Logged in as: {{ username }}</span>
    </div>
    
    <div id="terminal-container"></div>
    
    <!-- Mobile quick-access buttons -->
    <div id="mobile-buttons">
        <button onclick="insertCommand('list')">list</button>
        <button onclick="insertCommand('new')">new</button>
        <button onclick="insertCommand('search')">search</button>
        <button onclick="insertCommand('help')">help</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.terminal/2.37.2/js/jquery.terminal.min.js"></script>
    <script>
        $(function() {
            let term = $('#terminal-container').terminal(function(command) {
                if (command.trim() === '') {
                    return;
                }
                
                // Show a simple loading indicator instead of using spinner
                term.pause();
                const loadingIndicator = term.echo('Processing command... ⏳', {
                    finalize: function(div) {
                        $(div).addClass('loading-indicator');
                    }
                });
                
                // Send command to server API
                $.ajax({
                    url: '/api/command',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ command: command }),
                    success: function(response) {
                        term.resume();
                        
                        // Remove the loading indicator
                        $('.loading-indicator').remove();
                        
                        // Output response with HTML formatting enabled
                        term.echo(response.result, {
                            raw: true,
                            finalize: function(div) {
                                div.find('.green').css('color', '#90ee90');
                                div.find('.blue').css('color', '#add8e6');
                                div.find('.yellow').css('color', '#ffff00');
                                div.find('.red').css('color', '#ff6347');
                                div.find('.cyan').css('color', '#00ffff');
                                div.find('.bold').css('font-weight', 'bold');
                            }
                        });
                    },
                    error: function(xhr) {
                        term.resume();
                        
                        // Remove the loading indicator
                        $('.loading-indicator').remove();
                        
                        term.error('Server error: ' + (xhr.responseText || 'Connection failed'));
                    }
                });
            }, {
                greetings: `
█████ █████ ████████ ████████ ██
   █  ██       ██       ██    ██
 ██   █████    ██       ██    ██   
█     ██       ██       ██    ██
█████ █████    ██       ██    ███████

Welcome to Zettl Web Terminal. Type 'help' for commands.
Type 'list' to see your recent notes.
`,
                prompt: 'zettl> ',
                name: 'zettl-web',
                historySize: 100,
                clear: false,
                exit: false,
                wrap: true,
                historyPersistedState: true,
                scrollOnEcho: true,
                height: '100%'
            });
            
            // Cache command history locally in browser
            if (localStorage.getItem('zettl_history')) {
                try {
                    const history = JSON.parse(localStorage.getItem('zettl_history'));
                    for (const cmd of history) {
                        term.history().append(cmd);
                    }
                } catch (e) {
                    console.error('Error loading history:', e);
                }
            }
            
            // Save history when commands are entered
            term.on('history', function(command) {
                const history = term.history().data();
                localStorage.setItem('zettl_history', JSON.stringify(history));
            });
            
            // Helper function to insert commands from mobile buttons
            window.insertCommand = function(cmd) {
                term.insert(cmd + ' ');
                term.focus();
            };
            
            // Mobile keyboard optimization
            if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                // Focus on terminal when page loads
                setTimeout(function() {
                    term.focus();
                }, 500);
                
                // Make command prompt more visible on mobile
                $('.prompt').css('font-weight', 'bold');
                
                // Mobile keyboard enhancements for special keys
                $(document).on('keydown', function(e) {
                    // Add quick access keys here if needed
                });
            }
        });
    </script>
</body>
</html>