<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Zettl Web</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/jquery.terminal/2.37.2/css/jquery.terminal.min.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            background-color: #1a1a1a;
            font-family: 'Courier New', monospace;
            display: flex;
            flex-direction: column;
        }
        
        #header {
            background-color: #333;
            color: #90ee90;
            padding: 10px 15px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        #terminal-container {
            flex: 1;
            width: 100%;
            position: relative;
            overflow: auto;  /* Enable native scrolling for better performance */
            -webkit-overflow-scrolling: touch; /* Enable momentum scrolling on iOS */
        }
        
        /* Override terminal styles for better mobile experience */
        .terminal {
            --size: 1.2;
            height: 100%;
            overflow: auto;    /* Ensure terminal has scrolling enabled */
            -webkit-transform: translateZ(0); /* Hardware acceleration for smoother scrolling */
            will-change: transform; /* Performance optimization */
        }
        
        /* Custom terminal colors to match Zettl CLI */
        .terminal .green {
            color: #90ee90;
        }
        
        .terminal .blue {
            color: #add8e6;
        }
        
        .terminal .yellow {
            color: #ffff00;
        }
        
        .terminal .red {
            color: #ff6347;
        }
        
        .terminal .cyan {
            color: #00ffff;
        }
        
        .terminal .bold {
            font-weight: bold;
        }

        .terminal .output-line {
            line-height: 1.4;  /* Increase line height for better readability */
        }

        .terminal .note-separator {
            margin: 10px 0;
            border-bottom: 1px dashed #444;
        }

        /* Style for note blocks */
        .terminal .note-block {
            margin-bottom: 15px;
            padding: 5px;
            border-left: 3px solid #444;
        }

        /* Style terminal <br> elements for better spacing */
        .terminal br {
            line-height: 1.5;
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            html, body {
                height: 100%;
                overflow: auto;
                width: 100%;
            }
            
            .terminal {
                --size: 1.4; /* Larger text on mobile */
                -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
                padding-bottom: 60px; /* Extra space at bottom to prevent last line from being hidden */
                overflow: auto; /* Enable standard scrolling */
                height: auto; /* Allow terminal to expand */
                min-height: 80vh; /* Ensure minimum height */
            }
            
            #mobile-buttons {
                display: flex;
                justify-content: space-around;
                background-color: rgba(51, 51, 51, 0.9);
                padding: 10px 0;
                position: sticky;
                bottom: 0;
                left: 0;
                right: 0;
                z-index: 1000;
            }
            
            #mobile-buttons button {
                background-color: #4a4a4a;
                color: white;
                border: none;
                padding: 8px 12px;
                border-radius: 4px;
                font-family: 'Courier New', monospace;
                touch-action: manipulation; /* Prevent double-tap zoom */
                -webkit-tap-highlight-color: transparent; /* Remove tap highlight */
            }
        }
        
        @media (min-width: 769px) {
            #mobile-buttons, #mobile-keyboard {
                display: none;
            }
        }
        
        /* Mobile keyboard styling */
        #mobile-keyboard {
            position: sticky;
            bottom: 50px;
            left: 0;
            right: 0;
            background-color: rgba(30, 30, 30, 0.95);
            padding: 10px 0;
            z-index: 999;
            border-top: 1px solid #444;
            margin-bottom: -40px; /* Overlap with the bottom buttons */
        }
        
        .keyboard-row {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
        }
        
        #mobile-keyboard button {
            background-color: #333;
            color: white;
            border: 1px solid #555;
            padding: 10px 15px;
            margin: 5px;
            border-radius: 4px;
            min-width: 40px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Mobile controls container */
        #mobile-controls {
            position: sticky;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background-color: transparent;
        }
        
        /* Keyboard toggle button */
        #keyboard-toggle {
            position: fixed;
            bottom: 70px;
            right: 20px;
            background-color: rgba(70, 70, 70, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            font-size: 20px;
            z-index: 1000;
            display: none;
        }
        
        @media (max-width: 768px) {
            #keyboard-toggle {
                display: block;
            }
        }
        
        /* iOS-specific fixes */
        body.ios-device {
            /* Prevent Safari UI from disappearing */
            height: auto;
            /* Allow normal scrolling */
            overflow: auto;
        }
        
        body.ios-device .terminal {
            /* Allow content to scroll normally */
            overflow: auto;
            /* Add margin for keyboard visibility */
            margin-bottom: 50px;
        }
        
        /* Remove the black square */
        body.ios-device .cmd-line {
            /* No extra padding */
            padding-bottom: 0;
        }
    </style>
</head>
<body>
    <div id="header">
        <span>Zettl Web Terminal</span>
        <span>Logged in as: {{ username }}</span>
    </div>
    
    <!-- Keyboard toggle button for mobile -->
    <button id="keyboard-toggle" onclick="toggleKeyboard()">⌨️</button>
    
    <!-- Terminal Container -->
    <div id="terminal-container"></div>
    
    <!-- Absolute positioned mobile controls that float above keyboard -->
    <div id="keyboard-float-buttons" style="position: fixed; bottom: 0; left: 0; right: 0; z-index: 1001;">
        <!-- Custom mobile keyboard -->
        <div id="mobile-keyboard" style="display:none;">
            <div class="keyboard-row">
                <button onclick="insertSpecialKey('Tab')">Tab</button>
                <button onclick="insertSpecialKey('Escape')">Esc</button>
                <button onclick="insertSpecialKey('ArrowLeft')">←</button>
                <button onclick="insertSpecialKey('ArrowUp')">↑</button>
                <button onclick="insertSpecialKey('ArrowDown')">↓</button>
                <button onclick="insertSpecialKey('ArrowRight')">→</button>
                <button onclick="toggleKeyboard()">Hide</button>
            </div>
        </div>
        
        <!-- Mobile quick-access buttons -->
        <div id="mobile-buttons">
            <button onclick="insertCommand('list')">list</button>
            <button onclick="insertCommand('new')">new</button>
            <button onclick="insertCommand('search')">search</button>
            <button onclick="insertCommand('help')">help</button>
            <button onclick="insertSpecialKey('Tab')">Tab</button>
            <button onclick="insertSpecialKey('ArrowUp')">↑</button>
            <button onclick="insertSpecialKey('ArrowDown')">↓</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.terminal/2.37.2/js/jquery.terminal.min.js"></script>
    <script>
        $(function() {
            // Detect iOS device
            const isiOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            
            // iOS-specific body class
            if (isiOS) {
                $('body').addClass('ios-device');
            }
            
            // Enable mouse wheel scrolling globally
            $.terminal.defaults.mousewheel = true;

            let term = $('#terminal-container').terminal(function(command) {
                if (command.trim() === '') {
                    return;
                }
                
                // Show a simple loading indicator instead of using spinner
                term.pause();
                const loadingIndicator = term.echo('Processing command... ⏳', {
                    finalize: function(div) {
                        $(div).addClass('loading-indicator');
                    }
                });
                
                // Send command to server API
                $.ajax({
                    url: '/api/command',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ command: command }),
                    success: function(response) {
                        term.resume();
                        
                        // Remove the loading indicator
                        $('.loading-indicator').remove();
                        
                        // Output response with HTML formatting enabled
                        term.echo(response.result, {
                            raw: true,
                            finalize: function(div) {
                                div.find('.green').css('color', '#90ee90');
                                div.find('.blue').css('color', '#add8e6');
                                div.find('.yellow').css('color', '#ffff00');
                                div.find('.red').css('color', '#ff6347');
                                div.find('.cyan').css('color', '#00ffff');
                                div.find('.bold').css('font-weight', 'bold');
                            }
                        });
                    },
                    error: function(xhr) {
                        term.resume();
                        
                        // Remove the loading indicator
                        $('.loading-indicator').remove();
                        
                        term.error('Server error: ' + (xhr.responseText || 'Connection failed'));
                    }
                });
            }, {
                greetings: `
█████ █████ ████████ ████████ ██
   █  ██       ██       ██    ██
 ██   █████    ██       ██    ██   
█     ██       ██       ██    ██
█████ █████    ██       ██    ███████

Welcome to Zettl Web Terminal. Type 'help' for commands.
Type 'list' to see your recent notes.
`,
                prompt: 'zettl> ',
                name: 'zettl-web',
                historySize: 100,
                clear: false,
                exit: false,
                wrap: true,
                historyPersistedState: true,
                scrollOnEcho: false, // Disable scroll on echo for smoother performance
                mousewheel: false, // Disable mousewheel internal handler
                height: '100%',
                overflow: 'auto',
                touchscroll: true,  // Enable touch scrolling
                mobileDelete: true, // Better backspace handling on mobile
                smoothScroll: false, // Disable smooth scrolling for better performance
                scrollBottomOffset: 0 // No extra space at bottom
            });
            
            // Let native scrolling work for better performance
            // No custom scroll handlers

            // Cache command history locally in browser
            if (localStorage.getItem('zettl_history')) {
                try {
                    const history = JSON.parse(localStorage.getItem('zettl_history'));
                    for (const cmd of history) {
                        term.history().append(cmd);
                    }
                } catch (e) {
                    console.error('Error loading history:', e);
                }
            }
            
            // Save history when commands are entered
            term.on('history', function(command) {
                const history = term.history().data();
                localStorage.setItem('zettl_history', JSON.stringify(history));
            });
            
            // Helper function to insert commands from mobile buttons
            window.insertCommand = function(cmd) {
                term.insert(cmd + ' ');
                term.focus();
            };
            
            // Helper function to insert special keys
            window.insertSpecialKey = function(key) {
                const e = $.Event('keydown');
                switch(key) {
                    case 'Tab':
                        e.which = 9;
                        break;
                    case 'ArrowUp':
                        e.which = 38;
                        break;
                    case 'ArrowDown':
                        e.which = 40;
                        break;
                    case 'ArrowLeft':
                        e.which = 37;
                        break;
                    case 'ArrowRight':
                        e.which = 39;
                        break;
                    case 'Escape':
                        e.which = 27;
                        break;
                    default:
                        return;
                }
                term.trigger(e);
                term.focus();
            };
            
            // Toggle custom keyboard
            window.toggleKeyboard = function() {
                const keyboard = $('#mobile-keyboard');
                keyboard.toggle();
                term.focus();
            };
            
            // Add special handler for iOS cursor focus
            if (isiOS) {
                // Special iOS input handler to fix cursor jumping
                term.on('click', function() {
                    // Delay focus to help with iOS keyboard positioning
                    setTimeout(function() {
                        // Position cursor properly
                        const cmdLine = $('.cmd-line');
                        if (cmdLine.length) {
                            // Position cursor in middle of viewport after click
                            const cmdPos = cmdLine.offset().top;
                            const windowHeight = $(window).height();
                            $('html, body').scrollTop(cmdPos - windowHeight/3);
                        }
                    }, 100);
                });
                
                // No extra padding for iOS
            }
            
            // Mobile keyboard optimization
            if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                // Focus on terminal when page loads (with slight delay to ensure DOM is ready)
                setTimeout(function() {
                    term.focus();
                }, 800);
                
                // Make command prompt more visible on mobile
                $('.prompt').css('font-weight', 'bold');
                
                // Prevent zoom on double-tap for iOS
                $('body').css('touch-action', 'manipulation');
                
                // Fix for iOS erratic scrolling and text jumping to top when typing
                term.on('keypress', function(event) {
                    // Don't actually prevent default for the keypress or we'll lose input
                    // We just need to manage scrolling afterward
                    
                    // Force proper positioning of the cursor after a short delay
                    setTimeout(function() {
                        // Calculate position to keep current line in view
                        const terminal = $('.terminal');
                        const prompt = $('.terminal-output').last();
                        const promptBottom = prompt.position().top + prompt.height();
                        const visibleBottom = terminal.scrollTop() + terminal.height() - 100; // Extra space for keyboard
                        
                        // Only scroll if needed to make cursor visible
                        if (promptBottom > visibleBottom) {
                            terminal.scrollTop(promptBottom - terminal.height() + 150);
                        }
                        
                        // iOS-specific fix: ensure the cmd line stays visible in viewport
                        // This helps prevent the jumping behavior
                        const cmdLine = $('.cmd-line');
                        if (cmdLine.length) {
                            // Get the input position
                            const cmdPos = cmdLine.offset().top;
                            const windowHeight = $(window).height();
                            
                            // If the input would be hidden by keyboard, adjust scroll
                            if (cmdPos > windowHeight * 0.6) {
                                // Scroll to position the input at 1/3 from top
                                $('html, body').scrollTop(cmdPos - windowHeight/3);
                            }
                        }
                    }, 10);
                });
                
                // Handle viewport changes when keyboard appears/disappears
                let viewportHeight = window.innerHeight;
                $(window).on('resize', function() {
                    // Check if it's likely a keyboard-triggered resize
                    if (window.innerHeight < viewportHeight) {
                        // Keyboard appeared - adjust scrolling after delay
                        setTimeout(function() {
                            const terminal = $('.terminal');
                            const cursor = $('.cmd-cursor');
                            if (cursor.length) {
                                // Position terminal to keep cursor in view
                                const cursorPos = cursor.position().top;
                                const visibleArea = terminal.height() - 150;
                                terminal.scrollTop(terminal.scrollTop() + cursorPos - visibleArea);
                            }
                        }, 300);
                    } else {
                        // Keyboard disappeared - restore normal scroll
                        viewportHeight = window.innerHeight;
                    }
                });
                
                // Disable iOS text selection on double-tap
                $('#terminal-container').on('touchstart', function(e) {
                    e.preventDefault();
                    term.focus();
                    return true;
                });
            }
        });
    </script>
</body>
</html>