<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zettl Web</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/jquery.terminal/2.37.2/css/jquery.terminal.min.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            background-color: #1a1a1a;
            font-family: 'Courier New', monospace;
            display: flex;
            flex-direction: column;
        }
        
        #header {
            background-color: #333;
            color: #90ee90;
            padding: 10px 15px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        #terminal-container {
            flex: 1;
            width: 100%;
            overflow: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .terminal {
            --size: 1.2;
            height: 100%;
        }
        
        /* Terminal colors */
        .terminal .green { color: #90ee90; }
        .terminal .blue { color: #add8e6; }
        .terminal .yellow { color: #ffff00; }
        .terminal .red { color: #ff6347; }
        .terminal .cyan { color: #00ffff; }
        .terminal .bold { font-weight: bold; }
        
        /* Mobile styles */
        @media (max-width: 768px) {
            .terminal {
                --size: 1.4; /* Larger text on mobile */
            }
            
            /* Basic command buttons */
            #mobile-buttons {
                display: flex;
                justify-content: space-around;
                background-color: #333;
                padding: 10px 0;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                z-index: 1000;
            }
            
            #mobile-buttons button {
                background-color: #4a4a4a;
                color: white;
                border: none;
                padding: 8px 12px;
                border-radius: 4px;
                font-family: 'Courier New', monospace;
            }
            
            /* Space for mobile buttons */
            #terminal-container {
                padding-bottom: 60px;
            }
        }
        
        @media (min-width: 769px) {
            #mobile-buttons {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div id="header">
        <span>Zettl Web Terminal</span>
        <span>Logged in as: {{ username }}</span>
    </div>
    
    <div id="terminal-container"></div>
    
    <!-- Simple mobile buttons -->
    <div id="mobile-buttons">
        <button onclick="insertCommand('list')">list</button>
        <button onclick="insertCommand('new')">new</button>
        <button onclick="insertCommand('search')">search</button>
        <button onclick="insertCommand('help')">help</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.terminal/2.37.2/js/jquery.terminal.min.js"></script>
    <script>
        $(function() {
            // Mobile detection
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            
            // Terminal initialization
            let term = $('#terminal-container').terminal(function(command) {
                if (command.trim() === '') {
                    return;
                }
                
                // Show loading indicator
                term.pause();
                const loadingIndicator = term.echo('Processing command... ⏳', {
                    finalize: function(div) {
                        $(div).addClass('loading-indicator');
                    }
                });
                
                // Send command to server
                $.ajax({
                    url: '/api/command',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ command: command }),
                    success: function(response) {
                        term.resume();
                        $('.loading-indicator').remove();
                        
                        // Output response
                        term.echo(response.result, {
                            raw: true,
                            finalize: function(div) {
                                div.find('.green').css('color', '#90ee90');
                                div.find('.blue').css('color', '#add8e6');
                                div.find('.yellow').css('color', '#ffff00');
                                div.find('.red').css('color', '#ff6347');
                                div.find('.cyan').css('color', '#00ffff');
                                div.find('.bold').css('font-weight', 'bold');
                            }
                        });
                        
                        // Ensure visibility of terminal output
                        if (isMobile) {
                            setTimeout(function() {
                                term.scroll_to_bottom();
                            }, 10);
                        }
                    },
                    error: function(xhr) {
                        term.resume();
                        $('.loading-indicator').remove();
                        term.error('Server error: ' + (xhr.responseText || 'Connection failed'));
                    }
                });
            }, {
                greetings: `
█████ █████ ████████ ████████ ██
   █  ██       ██       ██    ██
 ██   █████    ██       ██    ██   
█     ██       ██       ██    ██
█████ █████    ██       ██    ███████

Welcome to Zettl Web Terminal. Type 'help' for commands.
Type 'list' to see your recent notes.
`,
                prompt: 'zettl> ',
                name: 'zettl-web',
                historySize: 100,
                clear: false,
                exit: false,
                wrap: true,
                historyPersistedState: true,
                scrollOnEcho: true,
                height: '100%'
            });
            
            // Handle command insertion from buttons
            window.insertCommand = function(cmd) {
                term.set_command(cmd + ' ');
                term.focus();
            };
            
            // Save history to local storage
            if (localStorage.getItem('zettl_history')) {
                try {
                    const history = JSON.parse(localStorage.getItem('zettl_history'));
                    for (const cmd of history) {
                        term.history().append(cmd);
                    }
                } catch (e) {
                    console.error('Error loading history:', e);
                }
            }
            
            term.on('history', function(command) {
                const history = term.history().data();
                localStorage.setItem('zettl_history', JSON.stringify(history));
            });
            
            // iOS-specific fix to ensure input line stays visible when typing
            if (isIOS) {
                // Focus on terminal when page loads
                setTimeout(function() {
                    term.focus();
                }, 500);
                
                // Simple keyboard visibility detector
                const originalHeight = window.innerHeight;
                $(window).on('resize', function() {
                    const currentHeight = window.innerHeight;
                    
                    // If keyboard is visible (height is significantly less)
                    if (currentHeight < originalHeight * 0.75) {
                        // Wait a moment for keyboard to fully appear
                        setTimeout(function() {
                            // Get command line
                            const cmdLine = $('.cmd-line').last();
                            if (cmdLine.length) {
                                // Use native scrollIntoView for best performance
                                cmdLine[0].scrollIntoView(false);
                            }
                        }, 300);
                    }
                });
                
                // When typing, ensure command line is visible
                term.on('keydown keypress', function() {
                    setTimeout(function() {
                        term.scroll_to_bottom();
                    }, 0);
                });
                
                // When clicking to position cursor, ensure it's visible
                $(document).on('click', '.cmd-line', function() {
                    setTimeout(function() {
                        const cmdLine = $('.cmd-line').last();
                        if (cmdLine.length) {
                            cmdLine[0].scrollIntoView(false);
                        }
                    }, 0);
                });
            }
        });
    </script>
</body>
</html>