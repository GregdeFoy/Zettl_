<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zettl Settings</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;700&family=JetBrains+Mono:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Neo-Brutalist Color Palette */
            --bg-main: #FFF8E7;
            --bg-dark: #1E1E1E;
            --primary: #FF5E5B;
            --secondary: #FFCC00;
            --accent: #00D9FF;
            --success: #00FF88;
            --text-dark: #1E1E1E;
            --text-light: #FFF8E7;
            --border-dark: #1E1E1E;
            --shadow-color: #1E1E1E;

            /* Legacy mappings */
            --bg-color: var(--bg-main);
            --header-bg: var(--secondary);
            --terminal-text: var(--text-dark);
            --primary-color: var(--primary);
            --button-bg: var(--bg-main);
            --button-hover: var(--accent);
            --input-bg: var(--bg-main);
            --input-border: var(--border-dark);
            --error: var(--primary);
            --warning: var(--secondary);

            /* Spacing & Borders */
            --border-width: 4px;
            --border-width-thick: 6px;
            --shadow-offset: 6px;
            --shadow-offset-lg: 10px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg-main);
            color: var(--text-dark);
            min-height: 100vh;
            position: relative;
        }

        /* Decorative background pattern */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                repeating-linear-gradient(
                    45deg,
                    transparent,
                    transparent 100px,
                    rgba(255, 94, 91, 0.03) 100px,
                    rgba(255, 94, 91, 0.03) 200px
                );
            pointer-events: none;
            z-index: 0;
        }

        #header {
            background: var(--secondary);
            border-bottom: var(--border-width-thick) solid var(--border-dark);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 var(--shadow-offset) 0 var(--shadow-color);
            position: relative;
            z-index: 100;
        }

        .logo {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 36px;
            font-weight: 700;
            letter-spacing: -3px;
            color: var(--text-dark);
            background: var(--bg-main);
            padding: 8px 20px;
            border: var(--border-width) solid var(--border-dark);
            box-shadow: var(--shadow-offset) var(--shadow-offset) 0 var(--shadow-color);
            transform: rotate(-2deg);
            display: inline-block;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }

        .logo:hover {
            transform: rotate(2deg) scale(1.05);
            box-shadow: var(--shadow-offset-lg) var(--shadow-offset-lg) 0 var(--shadow-color);
        }

        .username-badge {
            background: var(--bg-main);
            padding: 8px 16px;
            border: 3px solid var(--border-dark);
            font-weight: 700;
            box-shadow: 3px 3px 0 var(--shadow-color);
        }

        #header .actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        #header .actions a,
        #header .actions button {
            background: var(--primary);
            color: var(--text-light);
            border: var(--border-width) solid var(--border-dark);
            padding: 12px 20px;
            font-weight: 700;
            text-transform: uppercase;
            box-shadow: var(--shadow-offset) var(--shadow-offset) 0 var(--shadow-color);
            cursor: pointer;
            text-decoration: none;
            transition: all 0.15s;
            font-family: 'Space Grotesk', sans-serif;
            letter-spacing: 0.5px;
        }

        #header .actions a:hover,
        #header .actions button:hover {
            transform: translate(-2px, -2px);
            box-shadow: calc(var(--shadow-offset) + 2px) calc(var(--shadow-offset) + 2px) 0 var(--shadow-color);
        }

        #header .actions a:active,
        #header .actions button:active {
            transform: translate(4px, 4px);
            box-shadow: 2px 2px 0 var(--shadow-color);
        }

        .container {
            max-width: 1000px;
            margin: 40px auto;
            padding: 0 20px;
            position: relative;
            z-index: 1;
        }

        h1 {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 32px;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-dark);
            margin-bottom: 30px;
            background: var(--secondary);
            padding: 15px 25px;
            border: var(--border-width) solid var(--border-dark);
            box-shadow: var(--shadow-offset) var(--shadow-offset) 0 var(--shadow-color);
            display: inline-block;
            transform: rotate(-1deg);
        }

        .settings-section {
            background: var(--bg-main);
            border: var(--border-width-thick) solid var(--border-dark);
            box-shadow: var(--shadow-offset-lg) var(--shadow-offset-lg) 0 var(--shadow-color);
            margin-bottom: 30px;
            overflow: hidden;
        }

        .settings-section h2 {
            background: var(--accent);
            padding: 20px 25px;
            border-bottom: var(--border-width) solid var(--border-dark);
            font-family: 'Space Grotesk', sans-serif;
            font-size: 24px;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-dark);
            margin: 0;
        }

        .settings-content {
            padding: 25px;
        }

        .help-text {
            color: #999;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--terminal-text);
        }

        .form-group input[type="password"],
        .form-group input[type="text"] {
            width: 100%;
            padding: 15px;
            background: var(--bg-main);
            border: var(--border-width) solid var(--border-dark);
            color: var(--text-dark);
            font-family: 'JetBrains Mono', monospace;
            font-size: 16px;
            font-weight: 500;
            box-shadow: inset 3px 3px 0 rgba(30, 30, 30, 0.1);
        }

        .form-group input:focus {
            outline: none;
            box-shadow: inset 0 0 0 3px var(--accent);
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            background: var(--success);
            color: var(--text-dark);
            border: var(--border-width) solid var(--border-dark);
            padding: 15px 24px;
            font-weight: 700;
            font-size: 14px;
            text-transform: uppercase;
            box-shadow: var(--shadow-offset) var(--shadow-offset) 0 var(--shadow-color);
            cursor: pointer;
            transition: all 0.15s;
            font-family: 'Space Grotesk', sans-serif;
        }

        .btn:hover {
            transform: translate(-2px, -2px);
            box-shadow: calc(var(--shadow-offset) + 2px) calc(var(--shadow-offset) + 2px) 0 var(--shadow-color);
        }

        .btn:active {
            transform: translate(4px, 4px);
            box-shadow: 2px 2px 0 var(--shadow-color);
        }

        .btn-secondary {
            background: var(--accent);
            color: var(--text-dark);
        }

        .btn-danger {
            background: var(--primary);
            color: var(--text-light);
        }

        .status-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }

        .status-message.success {
            background-color: rgba(144, 238, 144, 0.2);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .status-message.error {
            background-color: rgba(255, 99, 71, 0.2);
            color: var(--error);
            border: 1px solid var(--error);
        }

        .tokens-list {
            margin-top: 20px;
        }

        .token-item {
            background-color: var(--input-bg);
            border: 1px solid var(--input-border);
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .token-info {
            flex: 1;
            min-width: 200px;
        }

        .token-info strong {
            color: var(--primary-color);
            display: block;
            margin-bottom: 5px;
        }

        .token-preview {
            font-family: 'Courier New', monospace;
            color: #999;
            font-size: 12px;
            display: block;
            margin: 5px 0;
        }

        .token-date {
            color: #999;
            font-size: 12px;
            display: block;
        }

        .new-token-display {
            background-color: rgba(255, 255, 0, 0.1);
            border: 2px solid var(--warning);
            border-radius: 4px;
            padding: 20px;
            margin: 20px 0;
        }

        .new-token-display strong {
            color: var(--warning);
            display: block;
            margin-bottom: 15px;
        }

        .new-token-display code {
            background-color: var(--bg-color);
            color: var(--primary-color);
            padding: 10px;
            border-radius: 4px;
            display: block;
            margin: 10px 0;
            word-break: break-all;
            font-size: 13px;
        }

        .mb-3 {
            margin-bottom: 15px;
        }

        @media (max-width: 768px) {
            .container {
                margin: 20px auto;
            }

            .token-item {
                flex-direction: column;
                align-items: flex-start;
            }

            .button-group {
                width: 100%;
            }

            .btn {
                flex: 1;
            }
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="header">
        <a href="/" class="logo">ZETTL</a>
        <div class="actions">
            <button onclick="window.location.href='/'" class="btn-back">‚Üê BACK</button>
        </div>
        <span class="username-badge">{{ username }}</span>
    </div>

    <div class="container">
        <h1>Settings</h1>

        <!-- Claude API Key Section -->
        <div class="settings-section">
            <h2>Claude API Key</h2>
            <div class="settings-content">
                <p class="help-text">Add your Anthropic API key to enable AI features in your notes</p>

                <div class="form-group">
                <label for="claude-api-key">API Key</label>
                <input type="password"
                       id="claude-api-key"
                       placeholder="sk-ant-..."
                       autocomplete="off">
            </div>

            <div class="button-group">
                <button onclick="saveClaudeKey()" class="btn">Save API Key</button>
                <button onclick="toggleKeyVisibility()" class="btn btn-secondary">Show/Hide</button>
            </div>

            <div id="claude-status" class="status-message"></div>
            </div>
        </div>

        <!-- CLI Tokens Section -->
        <div class="settings-section">
            <h2>CLI Access Tokens</h2>
            <div class="settings-content">
                <p class="help-text">Generate tokens to use Zettl from the command line</p>

            <button onclick="generateToken()" class="btn mb-3">Generate New Token</button>

            <div id="new-token-container"></div>

            <div id="tokens-list" class="tokens-list">
                <p style="color: #999;">Loading tokens...</p>
            </div>
            </div>
        </div>

        <!-- Button Visibility Section -->
        <div class="settings-section">
            <h2>Button Visibility</h2>
            <div class="settings-content">
                <p class="help-text">Choose which command buttons to show in the main interface</p>

            <div id="button-visibility-container" style="margin-top: 20px;">
                <!-- Buttons will be populated by JavaScript with categories -->
            </div>

            <div class="button-group" style="margin-top: 20px;">
                <button onclick="saveButtonPreferences()" class="btn">Save Preferences</button>
                <button onclick="resetButtonPreferences()" class="btn btn-secondary">Show All</button>
            </div>

            <div id="button-status" class="status-message"></div>
            </div>
        </div>
    </div>

    <script>
        // Load settings data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
        });

        // Available buttons list (matches topLevelCommands in index.html)
        const availableButtons = [
            // Note Creation/Editing
            'task', 'idea', 'note', 'project', 'edit', 'append', 'prepend', 'delete',
            // Viewing
            'show', 'list', 'search',
            // Organization
            'tags', 'untag', 'link', 'unlink', 'related', 'graph', 'merge',
            // AI
            'llm',
            // Special Features
            'todos', 'rules',
            // System
            'api-key', 'help', 'clear', 'settings', 'logout'
        ];
        let hiddenButtons = [];

        async function loadSettings() {
            try {
                const response = await fetch('/api/settings/data');
                const data = await response.json();

                if (data.success) {
                    const settings = data.data;

                    // Load Claude API key
                    if (settings.claude_api_key) {
                        document.getElementById('claude-api-key').value = settings.claude_api_key;
                    }

                    // Load CLI tokens
                    displayTokens(settings.cli_tokens || []);

                    // Load hidden buttons
                    hiddenButtons = settings.hidden_buttons || [];
                    displayButtonVisibility();
                } else {
                    console.error('Failed to load settings:', data.error);
                }
            } catch (e) {
                console.error('Error loading settings:', e);
            }
        }

        function displayButtonVisibility() {
            const container = document.getElementById('button-visibility-container');
            container.innerHTML = '';
            container.style.cssText = 'display: block;'; // Change to block for categories

            const categories = {
                'Note Creation/Editing': ['task', 'idea', 'note', 'project', 'edit', 'append', 'prepend', 'delete'],
                'Viewing': ['show', 'list', 'search'],
                'Organization': ['tags', 'untag', 'link', 'unlink', 'related', 'graph', 'merge'],
                'AI': ['llm'],
                'Special Features': ['todos', 'rules'],
                'System': ['api-key', 'help', 'clear', 'settings', 'logout']
            };

            Object.entries(categories).forEach(([categoryName, buttons]) => {
                // Create category header
                const categoryHeader = document.createElement('h3');
                categoryHeader.textContent = categoryName;
                categoryHeader.style.cssText = 'color: var(--primary-color); margin-top: 20px; margin-bottom: 10px; font-size: 16px;';
                container.appendChild(categoryHeader);

                // Create grid for this category's buttons
                const categoryGrid = document.createElement('div');
                categoryGrid.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; margin-bottom: 15px;';

                buttons.forEach(buttonName => {
                    const isHidden = hiddenButtons.includes(buttonName);

                    const checkboxWrapper = document.createElement('div');
                    checkboxWrapper.style.cssText = 'display: flex; align-items: center; padding: 5px;';

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `btn-${buttonName}`;
                    checkbox.checked = !isHidden; // Checked means visible
                    checkbox.style.cssText = 'margin-right: 8px; cursor: pointer; width: 16px; height: 16px;';

                    const label = document.createElement('label');
                    label.htmlFor = `btn-${buttonName}`;
                    label.textContent = buttonName;
                    label.style.cssText = 'cursor: pointer; user-select: none;';

                    checkboxWrapper.appendChild(checkbox);
                    checkboxWrapper.appendChild(label);
                    categoryGrid.appendChild(checkboxWrapper);
                });

                container.appendChild(categoryGrid);
            });
        }

        async function saveButtonPreferences() {
            const statusEl = document.getElementById('button-status');

            // Collect hidden buttons (unchecked checkboxes)
            const newHiddenButtons = [];
            availableButtons.forEach(buttonName => {
                const checkbox = document.getElementById(`btn-${buttonName}`);
                if (!checkbox.checked) {
                    newHiddenButtons.push(buttonName);
                }
            });

            // Show loading state
            statusEl.style.display = 'block';
            statusEl.className = 'status-message';
            statusEl.innerHTML = 'Saving...';

            try {
                const response = await fetch('/api/settings/hidden-buttons', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({hidden_buttons: newHiddenButtons})
                });

                const data = await response.json();

                if (data.success) {
                    hiddenButtons = newHiddenButtons;
                    statusEl.className = 'status-message success';
                    statusEl.innerHTML = '‚úì Button preferences saved successfully';
                } else {
                    statusEl.className = 'status-message error';
                    statusEl.innerHTML = '‚úó ' + (data.error || 'Failed to save preferences');
                }
            } catch (e) {
                statusEl.className = 'status-message error';
                statusEl.innerHTML = '‚úó Error: ' + e.message;
            }

            // Hide after 5 seconds
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 5000);
        }

        async function resetButtonPreferences() {
            // Check all checkboxes
            availableButtons.forEach(buttonName => {
                const checkbox = document.getElementById(`btn-${buttonName}`);
                checkbox.checked = true;
            });

            // Save empty array (show all)
            await saveButtonPreferences();
        }

        function displayTokens(tokens) {
            const tokensList = document.getElementById('tokens-list');

            if (tokens.length === 0) {
                tokensList.innerHTML = '<p style="color: #999;">No CLI tokens yet. Generate one to get started!</p>';
                return;
            }

            tokensList.innerHTML = '';

            tokens.forEach(token => {
                const tokenDiv = document.createElement('div');
                tokenDiv.className = 'token-item';

                const tokenInfo = document.createElement('div');
                tokenInfo.className = 'token-info';

                const name = document.createElement('strong');
                name.textContent = token.name || 'Unnamed Token';
                tokenInfo.appendChild(name);

                const preview = document.createElement('span');
                preview.className = 'token-preview';
                preview.textContent = `ID: ${token.id}`;
                tokenInfo.appendChild(preview);

                const created = document.createElement('span');
                created.className = 'token-date';
                created.textContent = `Created: ${new Date(token.created_at).toLocaleDateString()}`;
                tokenInfo.appendChild(created);

                if (token.last_used) {
                    const lastUsed = document.createElement('span');
                    lastUsed.className = 'token-date';
                    lastUsed.textContent = `Last used: ${new Date(token.last_used).toLocaleString()}`;
                    tokenInfo.appendChild(lastUsed);
                }

                tokenDiv.appendChild(tokenInfo);

                const revokeBtn = document.createElement('button');
                revokeBtn.className = 'btn btn-danger';
                revokeBtn.textContent = 'Revoke';
                revokeBtn.onclick = () => revokeToken(token.id);
                tokenDiv.appendChild(revokeBtn);

                tokensList.appendChild(tokenDiv);
            });
        }

        async function saveClaudeKey() {
            const apiKey = document.getElementById('claude-api-key').value.trim();
            const statusEl = document.getElementById('claude-status');

            // Show loading state
            statusEl.style.display = 'block';
            statusEl.className = 'status-message';
            statusEl.innerHTML = 'Saving...';

            try {
                const response = await fetch('/api/settings/claude-key', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({api_key: apiKey})
                });

                const data = await response.json();

                if (data.success) {
                    statusEl.className = 'status-message success';
                    statusEl.innerHTML = '‚úì API key saved successfully';
                } else {
                    statusEl.className = 'status-message error';
                    statusEl.innerHTML = '‚úó ' + (data.error || 'Failed to save API key');
                }
            } catch (e) {
                statusEl.className = 'status-message error';
                statusEl.innerHTML = '‚úó Error: ' + e.message;
            }

            // Hide after 5 seconds
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 5000);
        }

        async function generateToken() {
            const name = prompt('Enter a name for this token (optional):');
            if (name === null) return; // User cancelled

            const newTokenContainer = document.getElementById('new-token-container');
            newTokenContainer.innerHTML = '<p style="color: #999;">Generating token...</p>';

            try {
                const response = await fetch('/api/cli-token/generate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name: name || 'CLI Token'})
                });

                const data = await response.json();

                if (data.success && data.token) {
                    // Show token ONCE with copy button
                    const tokenDisplay = document.createElement('div');
                    tokenDisplay.className = 'new-token-display';
                    tokenDisplay.innerHTML = `
                        <strong>‚ö†Ô∏è Save this token - it won't be shown again!</strong>
                        <code id="new-token">${data.token}</code>
                        <div class="button-group">
                            <button class="btn" onclick="copyToken('${data.token}')">üìã Copy to Clipboard</button>
                            <button class="btn btn-secondary" onclick="document.getElementById('new-token-container').innerHTML = ''">Done</button>
                        </div>
                        <p style="margin-top: 15px; color: #999;">
                            To use this token with the CLI, run:<br>
                            <code style="background-color: var(--bg-color); padding: 5px; display: inline-block; margin-top: 5px;">zettl auth setup</code>
                        </p>
                    `;

                    newTokenContainer.innerHTML = '';
                    newTokenContainer.appendChild(tokenDisplay);

                    // Reload token list
                    setTimeout(() => {
                        loadSettings();
                    }, 1000);
                } else {
                    newTokenContainer.innerHTML = `<p style="color: var(--error);">Error: ${data.error || 'Failed to generate token'}</p>`;
                }
            } catch (e) {
                newTokenContainer.innerHTML = `<p style="color: var(--error);">Error: ${e.message}</p>`;
            }
        }

        async function revokeToken(tokenId) {
            if (!confirm('Revoke this token? Any CLI using it will stop working.')) {
                return;
            }

            try {
                const response = await fetch(`/api/cli-token/${tokenId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    // Reload settings to refresh token list
                    loadSettings();
                } else {
                    alert('Error revoking token: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Error revoking token: ' + e.message);
            }
        }

        function copyToken(token) {
            navigator.clipboard.writeText(token).then(() => {
                alert('Token copied to clipboard!');
            }).catch(() => {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = token;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('Token copied to clipboard!');
            });
        }

        function toggleKeyVisibility() {
            const input = document.getElementById('claude-api-key');
            input.type = input.type === 'password' ? 'text' : 'password';
        }
    </script>
</body>
</html>
